<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="CombineDistributions">
<title>Aggregating predictions from an SIRS model • CombineDistributions</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Aggregating predictions from an SIRS model">
<meta property="og:description" content="CombineDistributions">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">CombineDistributions</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/intro-vignette.html">Introduction to CombineDistributions</a>
    <a class="dropdown-item" href="../articles/SIRS-vignette.html">Aggregating predictions from an SIRS model</a>
    <a class="dropdown-item" href="../articles/MMODS-vignette.html">Aggregation and trimming on real-world COVID-19 death predictions</a>
    <a class="dropdown-item" href="../articles/tidy-tuesday-example-analysis.html">Example Analysis</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Aggregating predictions from an SIRS model</h1>
            
      
      
      <div class="d-none name"><code>SIRS-vignette.Rmd</code></div>
    </div>

    
    
<p>This vignette implements the first case study from <span class="citation">(Howerton et al., n.d.)</span>. We simulate a
multi-model effort to evaluate the performance of various aggregation
methods when applied to distributions of public health outcomes.</p>
<p>To start, we load a few packages.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># for aggregation</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://m-qin.github.io/CombineDistributions/" class="external-link">CombineDistributions</a></span><span class="op">)</span> </span>
<span><span class="co"># for scoring</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">pracma</span><span class="op">)</span></span>
<span><span class="co"># for data manipulation</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span> </span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="co"># for plotting</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://scales.r-lib.org" class="external-link">scales</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://wilkelab.org/cowplot/" class="external-link">cowplot</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="co"># for rmd</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://yihui.org/knitr/" class="external-link">knitr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># set seed so we can replicate results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">20</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># test if a directory named "figures" exists locally, if not create it</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.exists</a></span><span class="op">(</span><span class="st">"../figures"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="st">"../figures"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">fig_path</span> <span class="op">&lt;-</span> <span class="st">"../figures/"</span></span></code></pre></div>
<div class="section level2">
<h2 id="sirs-model">SIRS Model<a class="anchor" aria-label="anchor" href="#sirs-model"></a>
</h2>
<p>We use an SIRS (susceptible-infected-recovered-susceptible) model
implemented stochastically with the chain-binomial framework <span class="citation">(Bailey 1957)</span>. All individuals in the population
are classified into one of the three compartments (S,I, or R), and we
define how many individuals transition between these states at each time
step:</p>
<table class="table">
<colgroup>
<col width="33%">
<col width="66%">
</colgroup>
<thead><tr class="header">
<th>Transition</th>
<th>Number of individuals transitioning</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>infection</td>
<td><span class="math inline">\(\delta_{S \rightarrow I}(t), \text{drawn
from}D_{S \rightarrow I}(t) \sim Binomial(S(t), 1 - e^{-\beta
I(t)/N})\)</span></td>
</tr>
<tr class="even">
<td>recovery</td>
<td><span class="math inline">\(\delta_{I \rightarrow R}(t), \text{drawn
from}D_{I \rightarrow R}(t) \sim Binomial(S(t), 1 -
e^{-\gamma})\)</span></td>
</tr>
<tr class="odd">
<td>waning</td>
<td><span class="math inline">\(\delta_{R \rightarrow S}(t), \text{drawn
from}D_{R \rightarrow S}(t) \sim Binomial(S(t), 1 -
e^{-\rho})\)</span></td>
</tr>
</tbody>
</table>
<p>We update the number of individuals in each compartment
accordingly:</p>
<p><span class="math display">\[
\begin{aligned}
S(t+1) &amp;= S(t) - \delta_{S \rightarrow I}(t) + \delta_{R \rightarrow
S}(t) \\
I(t+1) &amp;= I(t) + \delta_{S \rightarrow I}(t) - \delta_{I \rightarrow
R}(t)\\
R(t+1) &amp;= R(t) + \delta_{I \rightarrow R}(t) - \delta_{R \rightarrow
S}(t)\\
\end{aligned}
\]</span> We implement this process with two
functions,<code>run_cb_sir()</code> and <code>cb_sir()</code>, and
define a third function to collect the information we are interested in
from each simulation, <code>return_obj()</code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># implement chain binomial over time </span></span>
<span><span class="va">run_cb_sir</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">n_times</span>, <span class="va">sims</span>, <span class="va">IC</span>, <span class="va">beta</span>, <span class="va">gamma</span>, <span class="va">rho</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">class</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"S"</span>, <span class="st">"I"</span>, <span class="st">"R"</span>, <span class="st">"C"</span><span class="op">)</span></span>
<span>  <span class="va">ret</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">sims</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">class</span><span class="op">)</span>,<span class="va">n_times</span><span class="op">)</span>,dimnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="cn">NULL</span>, <span class="va">class</span>, <span class="cn">NULL</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co"># ret dimensions - 1: sims, 2: classes, 3: time</span></span>
<span>  <span class="va">ret</span><span class="op">[</span>,,<span class="fl">1</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">IC</span>,<span class="va">sims</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="va">sims</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span> <span class="op">)</span></span>
<span>  <span class="co"># repeate cb_sir() over time</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">ts</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="va">n_times</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">ret</span><span class="op">[</span>,,<span class="va">ts</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">cb_sir</span><span class="op">(</span><span class="va">sims</span>,delta.t <span class="op">=</span><span class="fl">1</span>, </span>
<span>                        S <span class="op">=</span> <span class="va">ret</span><span class="op">[</span>,<span class="st">"S"</span>,<span class="va">ts</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>,  </span>
<span>                        I <span class="op">=</span> <span class="va">ret</span><span class="op">[</span>,<span class="st">"I"</span>,<span class="va">ts</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>                        R <span class="op">=</span> <span class="va">ret</span><span class="op">[</span>,<span class="st">"R"</span>,<span class="va">ts</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>                        C <span class="op">=</span> <span class="va">ret</span><span class="op">[</span>,<span class="st">"C"</span>,<span class="va">ts</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>                        beta<span class="op">=</span><span class="va">beta</span>,gamma<span class="op">=</span><span class="va">gamma</span>,rho<span class="op">=</span><span class="va">rho</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="co"># calculate metrics of interest based on simulations</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>timeseries <span class="op">=</span> <span class="va">ret</span>, </span>
<span>              metrics <span class="op">=</span> <span class="fu">return_obj</span><span class="op">(</span><span class="va">ret</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># implement chain binomial for single time step</span></span>
<span><span class="va">cb_sir</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">S</span>, <span class="va">I</span>, <span class="va">R</span>, <span class="va">C</span>, <span class="va">beta</span>, <span class="va">gamma</span>, <span class="va">rho</span>, </span>
<span>                   <span class="va">sims</span>, <span class="va">delta.t</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">N</span> <span class="op">&lt;-</span> <span class="va">S</span><span class="op">+</span><span class="va">I</span><span class="op">+</span><span class="va">R</span></span>
<span>  <span class="co"># draw number of individuals transitioning between states</span></span>
<span>  <span class="va">dN_SI</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span>n<span class="op">=</span><span class="va">sims</span>,size<span class="op">=</span><span class="va">S</span>,prob<span class="op">=</span><span class="fl">1</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">beta</span><span class="op">*</span><span class="va">I</span><span class="op">/</span><span class="va">N</span><span class="op">*</span><span class="va">delta.t</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">dN_IR</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span>n<span class="op">=</span><span class="va">sims</span>,size<span class="op">=</span><span class="va">I</span>,prob<span class="op">=</span><span class="fl">1</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">gamma</span><span class="op">*</span><span class="va">delta.t</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">dN_RS</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span>n<span class="op">=</span><span class="va">sims</span>, size<span class="op">=</span><span class="va">R</span>, prob<span class="op">=</span><span class="fl">1</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">rho</span><span class="op">*</span><span class="va">delta.t</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co"># update states</span></span>
<span>  <span class="va">S</span> <span class="op">&lt;-</span> <span class="va">S</span> <span class="op">-</span> <span class="va">dN_SI</span> <span class="op">+</span> <span class="va">dN_RS</span></span>
<span>  <span class="va">I</span> <span class="op">&lt;-</span> <span class="va">I</span> <span class="op">+</span> <span class="va">dN_SI</span> <span class="op">-</span> <span class="va">dN_IR</span></span>
<span>  <span class="va">R</span> <span class="op">&lt;-</span> <span class="va">R</span> <span class="op">+</span> <span class="va">dN_IR</span> <span class="op">-</span> <span class="va">dN_RS</span></span>
<span>  <span class="va">C</span> <span class="op">&lt;-</span> <span class="va">C</span> <span class="op">+</span> <span class="va">dN_SI</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">S</span>, <span class="va">I</span>, <span class="va">R</span>, <span class="va">C</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># calculate metrics of interest (cumulative &amp; peak cases)</span></span>
<span><span class="va">return_obj</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">out</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># select only C compartment (cumulative cases over time)</span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">reshape2</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html" class="external-link">melt</a></span><span class="op">(</span><span class="va">out</span><span class="op">[</span>,<span class="st">"C"</span>,<span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sim"</span>, <span class="st">"time"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setDT.html" class="external-link">setDT</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span>  <span class="co"># cumulative cases = # cases in C at final time</span></span>
<span>  <span class="va">cum_cases</span> <span class="op">&lt;-</span> <span class="va">out</span><span class="op">[</span><span class="va">time</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span>,<span class="op">]</span></span>
<span>  <span class="va">cum_cases</span><span class="op">[</span>,<span class="va">time</span> <span class="op">:=</span><span class="cn">NULL</span><span class="op">]</span></span>
<span>  <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setattr.html" class="external-link">setnames</a></span><span class="op">(</span><span class="va">cum_cases</span>, <span class="st">"value"</span>, <span class="st">"cum_cases"</span><span class="op">)</span></span>
<span>  <span class="co"># peak cases = max(diff between C at t and t-1)</span></span>
<span>  <span class="va">peak_cases</span> <span class="op">&lt;-</span> <span class="va">out</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="va">peak_cases</span> <span class="op">&lt;-</span> <span class="va">peak_cases</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>peak_cases <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">sim</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">peak_cases</span>, <span class="va">cum_cases</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="defining-multiple-models">Defining “multiple models”<a class="anchor" aria-label="anchor" href="#defining-multiple-models"></a>
</h2>
<p>We vary the parameters to represent four distinct models (<span class="math inline">\(A\)</span>, <span class="math inline">\(B\)</span>, <span class="math inline">\(C\)</span>, and <span class="math inline">\(D\)</span>) with varying assumptions about the
transmission process. There are two types of uncertainty that these
models encapsulate:</p>
<ol style="list-style-type: decimal">
<li>
<strong>parametric uncertainty</strong> about the transmission rate,
<span class="math inline">\(\beta\)</span>. We assume that all four
models let <span class="math inline">\(\beta \sim N(\mu_\beta,
0.2)\)</span> and that <span class="math inline">\(\mu_\beta\)</span>
varies across models, with <span class="math inline">\(\mu_{\beta,A} =
1.2\)</span>, <span class="math inline">\(\mu_{\beta,B} = 1.4\)</span>,
<span class="math inline">\(\mu_{\beta,C} = 1.6\)</span>, and <span class="math inline">\(\mu_{\beta,D} = 1.8\)</span>.</li>
<li>
<strong>structural uncertainty</strong> about the waning of
immunity, where models either assume transmission follows and SIR model
(no waning of immunity, i.e., <span class="math inline">\(rho =
0\)</span>) or that transmission follows and SIRS model (immunity wanes,
we let <span class="math inline">\(rho = 1/26\)</span>). We assume there
are three ways in which structural uncertainty can be represented in our
multi-model ensemble:
<ul>
<li>structural uncertainty is <em>not represented</em>: all models
assume no waning, i.e., <span class="math inline">\(\rho_{A,B,C,D} =
0\)</span>
</li>
<li>structural uncertainty is <em>represented between models</em>: two
models assume no waning and two assume waning, i.e., <span class="math inline">\(\rho_{A,C} = 0\)</span> and <span class="math inline">\(\rho_{B,D} = 1/26\)</span>
</li>
<li>structural uncertainty is <em>represented within models</em>: all
models incorporate both waning possibilities into their projections with
equal probability, i.e., <span class="math inline">\(\rho_{A,B,C,D} =
[1/26,0]\)</span>
</li>
</ul>
</li>
</ol>
<p>To implement these cases, we create a <code>data.frame</code> of
individual model parameter sets to consider.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># define the number of simulations per model</span></span>
<span><span class="va">n_samples</span> <span class="op">&lt;-</span> <span class="fl">10000</span></span>
<span></span>
<span><span class="co"># define mean and sd for transmission rate (beta) for each model</span></span>
<span><span class="va">m1_beta</span> <span class="op">&lt;-</span> <span class="fl">1.2</span>; <span class="va">m2_beta</span> <span class="op">&lt;-</span> <span class="fl">1.4</span>; <span class="va">m3_beta</span> <span class="op">&lt;-</span> <span class="fl">1.6</span>; <span class="va">m4_beta</span> <span class="op">&lt;-</span> <span class="fl">1.8</span></span>
<span><span class="va">sig_beta</span> <span class="op">&lt;-</span> <span class="fl">0.2</span></span>
<span></span>
<span><span class="co"># define unique beta for each simulation</span></span>
<span><span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_samples</span><span class="op">*</span><span class="fl">4</span>, </span>
<span>              <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">m1_beta</span>, <span class="va">n_samples</span><span class="op">)</span>, </span>
<span>                <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">m2_beta</span>, <span class="va">n_samples</span><span class="op">)</span>,</span>
<span>                <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">m3_beta</span>, <span class="va">n_samples</span><span class="op">)</span>,</span>
<span>                <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">m4_beta</span>, <span class="va">n_samples</span><span class="op">)</span><span class="op">)</span>, </span>
<span>              sd <span class="op">=</span> <span class="va">sig_beta</span><span class="op">)</span></span>
<span><span class="co"># verify all transmission rates are positive</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">beta</span> <span class="op">&lt;=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">#&gt; integer(0)</span></span>
<span></span>
<span><span class="co"># define unique recovery rate (gamma) for each simulation</span></span>
<span><span class="va">mu_recov_time</span> <span class="op">&lt;-</span> <span class="fl">1</span>; <span class="va">sig_recov_time</span> <span class="op">&lt;-</span> <span class="fl">0.1</span></span>
<span><span class="va">recov_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_samples</span><span class="op">*</span><span class="fl">4</span>, <span class="va">mu_recov_time</span>, <span class="va">sig_recov_time</span><span class="op">)</span> </span>
<span><span class="co"># verify all recovery times are positive</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">recov_time</span> <span class="op">&lt;=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">#&gt; integer(0)</span></span>
<span></span>
<span><span class="co"># define unique waning rate (rho) for each simulation and structural uncertainty scenario</span></span>
<span><span class="va">wane_time_unlikely</span> <span class="op">&lt;-</span> <span class="fl">0</span>; <span class="va">wane_time_likely</span> <span class="op">&lt;-</span> <span class="fl">26</span></span>
<span></span>
<span><span class="co"># structural uncertainty scenario 1: none</span></span>
<span><span class="co"># no models consider structural uncertainty</span></span>
<span><span class="va">rho_none</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">wane_time_unlikely</span>, <span class="va">n_samples</span><span class="op">*</span><span class="fl">4</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># structural uncertainty scenario 2: between models</span></span>
<span><span class="va">rho_btn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">wane_time_unlikely</span>, <span class="va">n_samples</span><span class="op">)</span>, <span class="co"># model A: waning unlikely</span></span>
<span>             <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">wane_time_likely</span>, <span class="va">n_samples</span><span class="op">)</span>,   <span class="co"># model B: waning likely</span></span>
<span>             <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">wane_time_unlikely</span>, <span class="va">n_samples</span><span class="op">)</span>, <span class="co"># model C: waning unlikely</span></span>
<span>             <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">wane_time_likely</span>, <span class="va">n_samples</span><span class="op">)</span><span class="op">)</span>   <span class="co"># model D: waning likely</span></span>
<span>             </span>
<span></span>
<span><span class="co"># structural uncertainty scenario 3: within models</span></span>
<span><span class="co"># all models assume wanings/no waning with equal probability</span></span>
<span><span class="va">rho_win</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">wane_time_unlikely</span>, <span class="va">n_samples</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">wane_time_likely</span>, <span class="va">n_samples</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>,<span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create data.frame of parameters for each uncertainty scenario</span></span>
<span><span class="co"># scenario 1: none</span></span>
<span><span class="va">none</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>beta <span class="op">=</span> <span class="va">beta</span>, recov_time <span class="op">=</span> <span class="va">recov_time</span>,rho <span class="op">=</span> <span class="va">rho_none</span>, </span>
<span>                   model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">LETTERS</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span>, <span class="va">n_samples</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                   struc_uncert <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span>
<span><span class="co"># scenario 2: between</span></span>
<span><span class="va">btn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>beta <span class="op">=</span> <span class="va">beta</span>, recov_time <span class="op">=</span> <span class="va">recov_time</span>, rho <span class="op">=</span> <span class="va">rho_btn</span>, </span>
<span>                  model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">LETTERS</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span>, <span class="va">n_samples</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                  struc_uncert <span class="op">=</span> <span class="st">"btn"</span><span class="op">)</span></span>
<span><span class="co"># scenario 3: within</span></span>
<span><span class="va">win</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>beta <span class="op">=</span> <span class="va">beta</span>, recov_time <span class="op">=</span> <span class="va">recov_time</span>, rho <span class="op">=</span> <span class="va">rho_win</span>, </span>
<span>                  model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">LETTERS</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span>, <span class="va">n_samples</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                  struc_uncert <span class="op">=</span> <span class="st">"win"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># combine all parameters into one data.frame</span></span>
<span><span class="va">all_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">none</span>, <span class="va">btn</span>, <span class="va">win</span><span class="op">)</span></span>
<span><span class="co"># correct any negative parameters and convert to rate</span></span>
<span><span class="va">all_params</span><span class="op">$</span><span class="va">gamma</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">all_params</span>, <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">recov_time</span> <span class="op">==</span> <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">/</span><span class="va">recov_time</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">all_params</span> <span class="op">&lt;-</span> <span class="va">all_params</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">recov_time</span><span class="op">)</span></span>
<span><span class="va">all_params</span><span class="op">$</span><span class="va">rho</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">all_params</span>, <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">rho</span> <span class="op">==</span> <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">/</span><span class="va">rho</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># add simulation number</span></span>
<span><span class="va">all_params</span><span class="op">$</span><span class="va">sim</span> <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">all_params</span><span class="op">)</span></span></code></pre></div>
<p>Here are the distributions of parameters for each model:</p>
</div>
<div class="section level2">
<h2 id="individual-model-projections">Individual model projections<a class="anchor" aria-label="anchor" href="#individual-model-projections"></a>
</h2>
<p>We simulate the model using all the parameter sets we’ve defined. To
do so, we need to define the length of the simulation (52 weeks),
population size (1000 individuals), and initial conditions (1.5%
infected, all else susceptible).</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># other model parameters</span></span>
<span><span class="cn">T</span> <span class="op">&lt;-</span> <span class="fl">52</span> <span class="co"># length of simulation  (in weeks)</span></span>
<span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">1000</span> <span class="co"># number of individuals in the population</span></span>
<span><span class="va">init</span> <span class="op">=</span> <span class="va">N</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>S <span class="op">=</span> <span class="fl">0.985</span>, I <span class="op">=</span> <span class="fl">0.015</span>, R <span class="op">=</span> <span class="fl">0</span>, C <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="co"># initial conditions</span></span>
<span></span>
<span><span class="co"># run the chain binomial model</span></span>
<span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">run_cb_sir</span><span class="op">(</span><span class="cn">T</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">all_params</span><span class="op">)</span>, <span class="va">init</span> , <span class="va">all_params</span><span class="op">$</span><span class="va">beta</span>, <span class="va">all_params</span><span class="op">$</span><span class="va">gamma</span>, <span class="va">all_params</span><span class="op">$</span><span class="va">rho</span><span class="op">)</span></span>
<span><span class="co"># reshape out metrics</span></span>
<span><span class="va">out</span><span class="op">$</span><span class="va">metrics</span> <span class="op">&lt;-</span> <span class="va">out</span><span class="op">$</span><span class="va">metrics</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">all_params</span><span class="op">)</span></span>
<span><span class="co"># reshape out time series</span></span>
<span><span class="va">out</span><span class="op">$</span><span class="va">timeseries</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">out</span><span class="op">$</span><span class="va">timeseries</span><span class="op">[</span>,<span class="st">"I"</span>,<span class="op">]</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">reshape2</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html" class="external-link">melt</a></span><span class="op">(</span><span class="st">"id"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>time <span class="op">=</span> <span class="va">variable</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"V"</span>,<span class="st">""</span>,<span class="va">time</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We plot the resulting simulations, which show outbreaks that either
fade out or have a second wave depending on assumptions about waning
immunity (green: no waning, orange: waning).</p>
<p><img src="SIRS-vignette_files/figure-html/timeseries-individual-dists-1.png" width="864"></p>
<p>Some simulations fade out early in the first wave, let’s identify in
how many simulations this occurs.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">inital_fadeout_thresh</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">out</span><span class="op">$</span><span class="va">metrics</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">struc_uncert</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">#filter() %&gt;%</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="op">(</span><span class="va">cum_cases</span> <span class="op">&lt;</span> <span class="va">inital_fadeout_thresh</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">model</th>
<th align="left">struc_uncert</th>
<th align="right">n</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">A</td>
<td align="left">btn</td>
<td align="right">42</td>
</tr>
<tr class="even">
<td align="left">A</td>
<td align="left">none</td>
<td align="right">40</td>
</tr>
<tr class="odd">
<td align="left">A</td>
<td align="left">win</td>
<td align="right">34</td>
</tr>
<tr class="even">
<td align="left">B</td>
<td align="left">btn</td>
<td align="right">2</td>
</tr>
<tr class="odd">
<td align="left">B</td>
<td align="left">none</td>
<td align="right">4</td>
</tr>
<tr class="even">
<td align="left">B</td>
<td align="left">win</td>
<td align="right">2</td>
</tr>
<tr class="odd">
<td align="left">C</td>
<td align="left">btn</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">C</td>
<td align="left">none</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">C</td>
<td align="left">win</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">D</td>
<td align="left">btn</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">D</td>
<td align="left">none</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">D</td>
<td align="left">win</td>
<td align="right">0</td>
</tr>
</tbody>
</table>
<p>Then, for each time series we track cumulative and peak cases. We
summarize the output into distributions (both pdfs and cdfs) for each
metric. For this vignette, we show results only for cumulative cases,
though all analyses are performed for peak cases as well.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># convert to long format</span></span>
<span><span class="va">out</span><span class="op">$</span><span class="va">metrics</span> <span class="op">&lt;-</span> <span class="fu">reshape2</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html" class="external-link">melt</a></span><span class="op">(</span><span class="va">out</span><span class="op">$</span><span class="va">metrics</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sim"</span>, <span class="st">"beta"</span>, <span class="st">"gamma"</span>, <span class="st">"rho"</span>, <span class="st">"model"</span>, <span class="st">"struc_uncert"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># CDFs</span></span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">999</span><span class="op">/</span><span class="fl">1000</span></span>
<span><span class="va">cdfs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setDT.html" class="external-link">setDT</a></span><span class="op">(</span><span class="va">out</span><span class="op">$</span><span class="va">metrics</span><span class="op">)</span><span class="op">[</span>,<span class="fu">.</span><span class="op">(</span>value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">value</span>, <span class="va">q</span><span class="op">)</span>, quantile <span class="op">=</span> <span class="va">q</span><span class="op">)</span>, </span>
<span>            by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">model</span>, <span class="va">struc_uncert</span>, <span class="va">variable</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># PDFs</span></span>
<span><span class="va">pdfs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setDT.html" class="external-link">setDT</a></span><span class="op">(</span><span class="va">out</span><span class="op">$</span><span class="va">metrics</span><span class="op">)</span><span class="op">[</span>,<span class="fu">.</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/density.html" class="external-link">density</a></span><span class="op">(</span><span class="va">value</span>, adjust <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">$</span><span class="va">x</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/density.html" class="external-link">density</a></span><span class="op">(</span><span class="va">value</span>, adjust <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">$</span><span class="va">y</span><span class="op">)</span>,</span>
<span>                   by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">model</span>, <span class="va">struc_uncert</span>, <span class="va">variable</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<p>We plot the distribution of outcomes for individual model projections
across the three uncertainty scenarios.</p>
<p><img src="SIRS-vignette_files/figure-html/plot-model-projections-1.png" width="768"></p>
</div>
<div class="section level2">
<h2 id="aggregating-outcomes">Aggregating outcomes<a class="anchor" aria-label="anchor" href="#aggregating-outcomes"></a>
</h2>
<p>Next, we aggregate the outcomes of our multi-model simulation using
both LOP and Vincent averages.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># aggregate cdfs</span></span>
<span><span class="va">agg_cdfs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/aggregate_cdfs.html">aggregate_cdfs</a></span><span class="op">(</span><span class="va">cdfs</span>, id_var <span class="op">=</span> <span class="st">"model"</span>, </span>
<span>                 group_by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"struc_uncert"</span>, <span class="st">"variable"</span><span class="op">)</span>,</span>
<span>                 method <span class="op">=</span> <span class="st">"LOP"</span>, </span>
<span>                 ret_quantiles <span class="op">=</span> <span class="va">q</span><span class="op">)</span><span class="op">[</span>,<span class="va">method</span><span class="op">:=</span><span class="st">"LOP"</span><span class="op">]</span>,</span>
<span>  <span class="fu"><a href="../reference/aggregate_cdfs.html">aggregate_cdfs</a></span><span class="op">(</span><span class="va">cdfs</span>, id_var <span class="op">=</span> <span class="st">"model"</span>, </span>
<span>                 group_by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"struc_uncert"</span>, <span class="st">"variable"</span><span class="op">)</span>,</span>
<span>                 method <span class="op">=</span> <span class="st">"vincent"</span>, </span>
<span>                 ret_quantiles <span class="op">=</span> <span class="va">q</span><span class="op">)</span><span class="op">[</span>,<span class="va">method</span> <span class="op">:=</span> <span class="st">"Vincent"</span><span class="op">]</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span><span class="co"># to get aggregate pdfs, sample from std. uniform and draw from distributions</span></span>
<span><span class="va">agg_pdfs</span> <span class="op">&lt;-</span> <span class="va">agg_cdfs</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>samps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/approxfun.html" class="external-link">approx</a></span><span class="op">(</span><span class="va">quantile</span>, <span class="va">value</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">100000</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">y</span><span class="op">)</span>, </span>
<span>                     by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">struc_uncert</span>, <span class="va">variable</span>, <span class="va">method</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="va">.</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">samps</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="va">.</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/density.html" class="external-link">density</a></span><span class="op">(</span><span class="va">samps</span>, adjust <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span><span class="op">$</span><span class="va">x</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/density.html" class="external-link">density</a></span><span class="op">(</span><span class="va">samps</span>, adjust <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span><span class="op">$</span><span class="va">y</span><span class="op">)</span>, </span>
<span>    by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">struc_uncert</span>, <span class="va">variable</span>, <span class="va">method</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<p>We plot the resulting aggregate distributions.</p>
<p><img src="SIRS-vignette_files/figure-html/plot-aggs-1.png" width="768"></p>
</div>
<div class="section level2">
<h2 id="evaluating-performance">Evaluating performance<a class="anchor" aria-label="anchor" href="#evaluating-performance"></a>
</h2>
<p>Next we test how well each of these aggregation methods perform,
given a range of assumptions about the future. Our assumptions about the
future transmission rate and waning of immunity are</p>
<table class="table">
<colgroup>
<col width="18%">
<col width="36%">
<col width="44%">
</colgroup>
<thead><tr class="header">
<th>Truth case</th>
<th>True mean transmission rate</th>
<th>True waning of immunity</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>case 1</td>
<td>model A assumption is correct, <span class="math inline">\(\mu_\beta
= 1.2\)</span>
</td>
<td>no waning, SIR</td>
</tr>
<tr class="even">
<td>case 2</td>
<td>model B assumption is correct, <span class="math inline">\(\mu_\beta
= 1.4\)</span>
</td>
<td>no waning, SIR</td>
</tr>
<tr class="odd">
<td>case 3</td>
<td>model C assumption is correct, <span class="math inline">\(\mu_\beta
= 1.6\)</span>
</td>
<td>no waning, SIR</td>
</tr>
<tr class="even">
<td>case 4</td>
<td>model D assumption is correct, <span class="math inline">\(\mu_\beta
= 1.8\)</span>
</td>
<td>no waning, SIR</td>
</tr>
<tr class="odd">
<td>case 5</td>
<td>truth is mean of model assumptions, <span class="math inline">\(\mu_\beta = 1.5\)</span>
</td>
<td>no waning, SIR</td>
</tr>
<tr class="even">
<td>case 6</td>
<td>model A assumption is correct, <span class="math inline">\(\mu_\beta
= 1.2\)</span>
</td>
<td>waning, SIRS</td>
</tr>
<tr class="odd">
<td>case 7</td>
<td>model B assumption is correct, <span class="math inline">\(\mu_\beta
= 1.4\)</span>
</td>
<td>waning, SIRS</td>
</tr>
<tr class="even">
<td>case 8</td>
<td>model C assumption is correct, <span class="math inline">\(\mu_\beta
= 1.6\)</span>
</td>
<td>waning, SIRS</td>
</tr>
<tr class="odd">
<td>case 9</td>
<td>model D assumption is correct, <span class="math inline">\(\mu_\beta
= 1.8\)</span>
</td>
<td>waning, SIRS</td>
</tr>
<tr class="even">
<td>case 10</td>
<td>truth is mean of model assumptions, <span class="math inline">\(\mu_\beta = 1.5\)</span>
</td>
<td>waning, SIRS</td>
</tr>
</tbody>
</table>
<p>We define a <code>data.frame</code> with these true parameter
values.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># define the number of synthetic future observations</span></span>
<span><span class="va">n_obs</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="co"># define true transmission rate</span></span>
<span><span class="va">obs_beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_obs</span>, <span class="va">m1_beta</span>, <span class="va">sig_beta</span><span class="op">)</span>,</span>
<span>              <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_obs</span>, <span class="va">m2_beta</span>, <span class="va">sig_beta</span><span class="op">)</span>,</span>
<span>              <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_obs</span>, <span class="va">m3_beta</span>, <span class="va">sig_beta</span><span class="op">)</span>,</span>
<span>              <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_obs</span>, <span class="va">m4_beta</span>, <span class="va">sig_beta</span><span class="op">)</span>,</span>
<span>              <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_obs</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">m1_beta</span>, <span class="va">m2_beta</span>, <span class="va">m3_beta</span>, <span class="va">m4_beta</span><span class="op">)</span><span class="op">)</span>,<span class="va">sig_beta</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># define true recovery rate</span></span>
<span><span class="va">obs_recov_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_obs</span><span class="op">*</span><span class="fl">5</span>, <span class="va">mu_recov_time</span>, <span class="va">sig_recov_time</span><span class="op">)</span> </span>
<span><span class="co"># define true waning</span></span>
<span><span class="va">obs_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>beta <span class="op">=</span> <span class="va">obs_beta</span>, obs_recov_time <span class="op">=</span> <span class="va">obs_recov_time</span>, rho <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">wane_time_likely</span> <span class="op">==</span> <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">/</span><span class="va">wane_time_likely</span><span class="op">)</span>, </span>
<span>                               true_beta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"m"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span>, <span class="st">"mean"</span><span class="op">)</span>, <span class="va">n_obs</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                               true_rho <span class="op">=</span> <span class="st">"Y"</span><span class="op">)</span>,</span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>beta <span class="op">=</span> <span class="va">obs_beta</span>, obs_recov_time <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="va">obs_recov_time</span>, rho <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">wane_time_unlikely</span> <span class="op">==</span> <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">/</span><span class="va">wane_time_unlikely</span><span class="op">)</span>, </span>
<span>                               true_beta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"m"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span>, <span class="st">"mean"</span><span class="op">)</span>, <span class="va">n_obs</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                               true_rho <span class="op">=</span> <span class="st">"N"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">obs_params</span><span class="op">$</span><span class="va">gamma</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">obs_params</span>, <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">obs_recov_time</span> <span class="op">==</span> <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">/</span><span class="va">obs_recov_time</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">obs_params</span><span class="op">$</span><span class="va">sim</span> <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">obs_params</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># simulate observations given these true params</span></span>
<span><span class="va">obs</span> <span class="op">&lt;-</span> <span class="fu">run_cb_sir</span><span class="op">(</span><span class="cn">T</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">obs_params</span><span class="op">)</span>, <span class="va">init</span>, <span class="va">obs_params</span><span class="op">$</span><span class="va">beta</span>, <span class="va">obs_params</span><span class="op">$</span><span class="va">gamma</span>, <span class="va">obs_params</span><span class="op">$</span><span class="va">rho</span><span class="op">)</span></span>
<span><span class="va">obs</span> <span class="op">&lt;-</span> <span class="va">obs</span><span class="op">$</span><span class="va">metrics</span></span>
<span><span class="va">obs</span> <span class="op">&lt;-</span> <span class="va">obs</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">obs_params</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">obs_recov_time</span><span class="op">)</span></span>
<span><span class="va">obs</span> <span class="op">&lt;-</span> <span class="fu">reshape2</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html" class="external-link">melt</a></span><span class="op">(</span><span class="va">obs</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sim"</span>, <span class="st">"beta"</span>, <span class="st">"gamma"</span>, <span class="st">"rho"</span>, <span class="st">"true_beta"</span>, <span class="st">"true_rho"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Doing so gives the following distribution of observations.</p>
<p><img src="SIRS-vignette_files/figure-html/unnamed-chunk-1-1.png" width="768"></p>
<p>We use the continuous rank probability score (CRPS) <span class="citation">(Matheson and Winkler 1976)</span> to assess
performance of the aggregate distributions against these synthetic
future observations.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># define function to implement CRPS </span></span>
<span><span class="co"># assume piecewise linear cdf, jumps to 0/1 after last defined quantile</span></span>
<span><span class="va">CRPS</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">q</span>,<span class="va">v</span>,<span class="va">o</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># add o into v to calculate area under curve</span></span>
<span>  <span class="va">v</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">v</span>, <span class="va">o</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co"># find integral cutoff where v = o</span></span>
<span>  <span class="va">vl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">v</span> <span class="op">==</span> <span class="va">o</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co"># assume values outside the define set of values and quantiles are 0 or 1 (jump)</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">vl</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="va">q</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">vl</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">q</span>,<span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">else</span><span class="op">{</span></span>
<span>    <span class="co"># add q_o into q to calculate area under curve</span></span>
<span>    <span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">q</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">vl</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">]</span>,<span class="cn">NA</span>,<span class="va">q</span><span class="op">[</span><span class="op">(</span><span class="va">vl</span><span class="op">)</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">q</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="co"># interpolate quantile for obs</span></span>
<span>    <span class="va">q_o</span> <span class="op">&lt;-</span> <span class="va">q</span><span class="op">[</span><span class="va">vl</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="op">(</span><span class="op">(</span><span class="va">q</span><span class="op">[</span><span class="va">vl</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="va">q</span><span class="op">[</span><span class="va">vl</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">v</span><span class="op">[</span><span class="va">vl</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="va">v</span><span class="op">[</span><span class="va">vl</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">*</span><span class="op">(</span><span class="va">o</span> <span class="op">-</span> <span class="va">v</span><span class="op">[</span><span class="va">vl</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="co"># add q_o into q to calculate area under curve</span></span>
<span>    <span class="va">q</span><span class="op">[</span><span class="va">vl</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">q_o</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="co"># calculate area of each trapezoid using CRPS formula for each subset</span></span>
<span>  <span class="va">areas_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pracma/man/trapz.html" class="external-link">trapz</a></span><span class="op">(</span><span class="va">v</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">vl</span><span class="op">]</span>, <span class="va">q</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">vl</span><span class="op">]</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="va">areas_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pracma/man/trapz.html" class="external-link">trapz</a></span><span class="op">(</span><span class="va">v</span><span class="op">[</span><span class="va">vl</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span><span class="op">]</span>, <span class="op">(</span><span class="va">q</span><span class="op">[</span><span class="va">vl</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span><span class="op">]</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="co"># return sum of areas</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">areas_1</span>, <span class="va">areas_2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># implement CRPS</span></span>
<span><span class="va">scores</span> <span class="op">&lt;-</span> <span class="va">obs</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">variable</span>, <span class="va">value</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>obs <span class="op">=</span> <span class="va">value</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>obs_num <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">obs</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">agg_cdfs</span><span class="op">)</span></span>
<span><span class="co"># get CRPS score</span></span>
<span><span class="va">scores</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setDT.html" class="external-link">setDT</a></span><span class="op">(</span><span class="va">scores</span><span class="op">)</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>CRPS <span class="op">=</span> <span class="fu">CRPS</span><span class="op">(</span><span class="va">quantile</span>,<span class="va">value</span>,<span class="va">obs</span><span class="op">)</span><span class="op">)</span>, <span class="co">#</span></span>
<span>                   by<span class="op">=</span><span class="fu">.</span><span class="op">(</span><span class="va">method</span>, <span class="va">variable</span>, <span class="va">struc_uncert</span>, <span class="va">obs_num</span>, <span class="va">obs</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<p>The CRPS results can be plotted for the LOP and Vincent aggregates
across three structural uncertainty scenarios.</p>
<p><img src="SIRS-vignette_files/figure-html/plot-CRPS-1.png" width="864"></p>
<p>And we can show when LOP and Vincent perform better by plotting the
difference between CRPS for each.</p>
<p><img src="SIRS-vignette_files/figure-html/plot-CRPS-diff-1.png" width="864"></p>
<p>Then, if we combine these score differences with the frequency at
which each observation occurs in the synthetic observations, we can
generate a distribution of relative performance. We summarize that
distribution with a few intervals.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">scores_all</span> <span class="op">&lt;-</span> <span class="va">obs</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">scores</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"variable"</span>, <span class="st">"value"</span> <span class="op">=</span> <span class="st">"obs"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">reshape2</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/cast.html" class="external-link">dcast</a></span><span class="op">(</span><span class="va">variable</span> <span class="op">+</span> <span class="va">true_beta</span> <span class="op">+</span> <span class="va">true_rho</span> <span class="op">+</span> <span class="va">struc_uncert</span> <span class="op">+</span> </span>
<span>                    <span class="va">value</span> <span class="op">+</span> <span class="va">sim</span> <span class="op">~</span> <span class="va">method</span>, value.var <span class="op">=</span> <span class="st">"CRPS"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># calculate difference to see which method has better CRPS</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>diff <span class="op">=</span> <span class="va">Vincent</span> <span class="op">-</span> <span class="va">LOP</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># summarize distribution of differences</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">variable</span>, <span class="va">true_beta</span>, <span class="va">true_rho</span>, <span class="va">struc_uncert</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>lower <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">diff</span>, <span class="fl">0.025</span><span class="op">)</span>,</span>
<span>      lower_25 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">diff</span>, <span class="fl">0.25</span><span class="op">)</span>, </span>
<span>      med <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">diff</span><span class="op">)</span>,</span>
<span>      upper_75 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">diff</span>, <span class="fl">0.75</span><span class="op">)</span>,</span>
<span>      upper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">diff</span>, <span class="fl">0.975</span><span class="op">)</span>, </span>
<span>      <span class="co"># for plotting</span></span>
<span>      plot_y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">true_beta</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>plot_y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">plot_y</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="SIRS-vignette_files/figure-html/plot-CRPS2-1.png" width="864"></p>
</div>
<div class="section level2">
<h2 id="aggregating-with-an-outlier">Aggregating with an outlier<a class="anchor" aria-label="anchor" href="#aggregating-with-an-outlier"></a>
</h2>
<p>Lastly, we consider the effects of an outlier on the resulting
aggregate distributions. We run another set of model simulations with
<span class="math inline">\(\mu_\beta = 2.4\)</span>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># define unique beta for each simulation</span></span>
<span><span class="va">outlier_mu_beta</span> <span class="op">&lt;-</span> <span class="fl">2.4</span></span>
<span><span class="va">outlier_beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_samples</span>, </span>
<span>                      <span class="va">outlier_mu_beta</span>, </span>
<span>                      sd <span class="op">=</span> <span class="va">sig_beta</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># verify all transmission rates are positive</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">beta</span> <span class="op">&lt;=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">#&gt; integer(0)</span></span>
<span></span>
<span><span class="co"># define unique recovery rate (gamma) for each simulation</span></span>
<span><span class="va">outlier_recov_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_samples</span>, <span class="va">mu_recov_time</span>, <span class="va">sig_recov_time</span><span class="op">)</span> </span>
<span><span class="co"># verify all recovery times are positive</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">recov_time</span> <span class="op">&lt;=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">#&gt; integer(0)</span></span>
<span></span>
<span></span>
<span><span class="co"># create data.frame of parameters for each uncertainty scenario</span></span>
<span><span class="co"># scenario 1: none</span></span>
<span><span class="va">none</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>beta <span class="op">=</span> <span class="va">outlier_beta</span>, recov_time <span class="op">=</span> <span class="va">outlier_recov_time</span>,</span>
<span>                   rho <span class="op">=</span> <span class="va">wane_time_unlikely</span>, </span>
<span>                   model <span class="op">=</span> <span class="st">"E"</span>,</span>
<span>                   struc_uncert <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span>
<span><span class="co"># scenario 2: between</span></span>
<span><span class="va">btn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>beta <span class="op">=</span> <span class="va">outlier_beta</span>, recov_time <span class="op">=</span> <span class="va">outlier_recov_time</span>, </span>
<span>                  rho <span class="op">=</span> <span class="va">wane_time_unlikely</span>, </span>
<span>                  model <span class="op">=</span> <span class="st">"E"</span>,</span>
<span>                  struc_uncert <span class="op">=</span> <span class="st">"btn"</span><span class="op">)</span></span>
<span><span class="co"># scenario 3: within</span></span>
<span><span class="va">win</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>beta <span class="op">=</span> <span class="va">outlier_beta</span>, recov_time <span class="op">=</span> <span class="va">outlier_recov_time</span>, </span>
<span>                  rho <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">wane_time_unlikely</span>, <span class="va">n_samples</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">wane_time_likely</span>, <span class="va">n_samples</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                  model <span class="op">=</span> <span class="st">"E"</span>,</span>
<span>                  struc_uncert <span class="op">=</span> <span class="st">"win"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># combine all parameters into one data.frame</span></span>
<span><span class="va">outlier_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">none</span>, <span class="va">btn</span>, <span class="va">win</span><span class="op">)</span></span>
<span><span class="co"># correct any negative parameters and convert to rate</span></span>
<span><span class="va">outlier_params</span><span class="op">$</span><span class="va">gamma</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">outlier_params</span>, <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">recov_time</span> <span class="op">==</span> <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">/</span><span class="va">recov_time</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">outlier_params</span> <span class="op">&lt;-</span> <span class="va">outlier_params</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">recov_time</span><span class="op">)</span></span>
<span><span class="va">outlier_params</span><span class="op">$</span><span class="va">rho</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">outlier_params</span>, <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">rho</span> <span class="op">==</span> <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">/</span><span class="va">rho</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># add simulation number</span></span>
<span><span class="va">outlier_params</span><span class="op">$</span><span class="va">sim</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">all_params</span><span class="op">$</span><span class="va">sim</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">outlier_params</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># run the chain binomial model</span></span>
<span><span class="va">outlier_out</span> <span class="op">&lt;-</span> <span class="fu">run_cb_sir</span><span class="op">(</span><span class="cn">T</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">outlier_params</span><span class="op">)</span>, <span class="va">init</span> , <span class="va">outlier_params</span><span class="op">$</span><span class="va">beta</span>, <span class="va">outlier_params</span><span class="op">$</span><span class="va">gamma</span>, <span class="va">outlier_params</span><span class="op">$</span><span class="va">rho</span><span class="op">)</span></span>
<span><span class="co"># reshape outlier_out metrics</span></span>
<span><span class="va">outlier_out</span><span class="op">$</span><span class="va">metrics</span> <span class="op">&lt;-</span> <span class="va">outlier_out</span><span class="op">$</span><span class="va">metrics</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>sim <span class="op">=</span> <span class="va">sim</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">all_params</span><span class="op">$</span><span class="va">sim</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">outlier_params</span><span class="op">)</span></span>
<span><span class="co"># reshape outlier_out time series</span></span>
<span><span class="va">outlier_out</span><span class="op">$</span><span class="va">timeseries</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">outlier_out</span><span class="op">$</span><span class="va">timeseries</span><span class="op">[</span>,<span class="st">"I"</span>,<span class="op">]</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">all_params</span><span class="op">$</span><span class="va">sim</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">reshape2</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html" class="external-link">melt</a></span><span class="op">(</span><span class="st">"id"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>time <span class="op">=</span> <span class="va">variable</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"V"</span>,<span class="st">""</span>,<span class="va">time</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We approximate the individual distributions, including the outlier,
and plot the distribution of outcomes for individual model projections
across the three uncertainty scenarios.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># convert to long format</span></span>
<span><span class="va">outlier_out</span><span class="op">$</span><span class="va">metrics</span> <span class="op">&lt;-</span> <span class="fu">reshape2</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html" class="external-link">melt</a></span><span class="op">(</span><span class="va">outlier_out</span><span class="op">$</span><span class="va">metrics</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sim"</span>, <span class="st">"beta"</span>, <span class="st">"gamma"</span>, <span class="st">"rho"</span>, <span class="st">"model"</span>, <span class="st">"struc_uncert"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># CDFs</span></span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">999</span><span class="op">/</span><span class="fl">1000</span></span>
<span><span class="va">outlier_cdfs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setDT.html" class="external-link">setDT</a></span><span class="op">(</span><span class="va">outlier_out</span><span class="op">$</span><span class="va">metrics</span><span class="op">)</span><span class="op">[</span>,<span class="fu">.</span><span class="op">(</span>value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">value</span>, <span class="va">q</span><span class="op">)</span>, quantile <span class="op">=</span> <span class="va">q</span><span class="op">)</span>, </span>
<span>            by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">model</span>, <span class="va">struc_uncert</span>, <span class="va">variable</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># PDFs</span></span>
<span><span class="va">outlier_pdfs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setDT.html" class="external-link">setDT</a></span><span class="op">(</span><span class="va">outlier_out</span><span class="op">$</span><span class="va">metrics</span><span class="op">)</span><span class="op">[</span>,<span class="fu">.</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/density.html" class="external-link">density</a></span><span class="op">(</span><span class="va">value</span>, adjust <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">$</span><span class="va">x</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/density.html" class="external-link">density</a></span><span class="op">(</span><span class="va">value</span>, adjust <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">$</span><span class="va">y</span><span class="op">)</span>,</span>
<span>                   by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">model</span>, <span class="va">struc_uncert</span>, <span class="va">variable</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<p><img src="SIRS-vignette_files/figure-html/outlier-plot-model-projections-1.png" width="768"></p>
<p>Next, we aggregate the predictions with and without trimming (note we
only consider trimming of two values, lowest and highest, because there
are only five models).</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># aggregate cdfs</span></span>
<span><span class="va">agg_cdfs_outlier</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/aggregate_cdfs.html">aggregate_cdfs</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">cdfs</span>, <span class="va">outlier_cdfs</span><span class="op">)</span>, id_var <span class="op">=</span> <span class="st">"model"</span>, </span>
<span>                 group_by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"struc_uncert"</span>, <span class="st">"variable"</span><span class="op">)</span>,</span>
<span>                 method <span class="op">=</span> <span class="st">"LOP"</span>, </span>
<span>                 ret_quantiles <span class="op">=</span> <span class="va">q</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="va">.</span><span class="op">[</span>, <span class="st">":="</span> <span class="op">(</span>method<span class="op">=</span><span class="st">"LOP"</span>, </span>
<span>              ntrim <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">]</span>,</span>
<span>  <span class="fu"><a href="../reference/aggregate_cdfs.html">aggregate_cdfs</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">cdfs</span>, <span class="va">outlier_cdfs</span><span class="op">)</span>, id_var <span class="op">=</span> <span class="st">"model"</span>, </span>
<span>                 group_by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"struc_uncert"</span>, <span class="st">"variable"</span><span class="op">)</span>,</span>
<span>                 method <span class="op">=</span> <span class="st">"vincent"</span>, </span>
<span>                 ret_quantiles <span class="op">=</span> <span class="va">q</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="va">.</span><span class="op">[</span>, <span class="st">":="</span> <span class="op">(</span>method<span class="op">=</span><span class="st">"Vincent"</span>, </span>
<span>              ntrim <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">]</span>, </span>
<span>  <span class="co"># add trimmed aggregates</span></span>
<span>  <span class="fu"><a href="../reference/aggregate_cdfs.html">aggregate_cdfs</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">cdfs</span>, <span class="va">outlier_cdfs</span><span class="op">)</span>, id_var <span class="op">=</span> <span class="st">"model"</span>, </span>
<span>                 group_by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"struc_uncert"</span>, <span class="st">"variable"</span><span class="op">)</span>,</span>
<span>                 method <span class="op">=</span> <span class="st">"LOP"</span>, </span>
<span>                 ret_quantiles <span class="op">=</span> <span class="va">q</span>, </span>
<span>                 weighting_scheme <span class="op">=</span> <span class="st">"CDF_exterior"</span>, </span>
<span>                 n_trim <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="va">.</span><span class="op">[</span>, <span class="st">":="</span> <span class="op">(</span>method<span class="op">=</span><span class="st">"LOP"</span>, </span>
<span>              ntrim <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">]</span>,</span>
<span>  <span class="fu"><a href="../reference/aggregate_cdfs.html">aggregate_cdfs</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">cdfs</span>, <span class="va">outlier_cdfs</span><span class="op">)</span>, id_var <span class="op">=</span> <span class="st">"model"</span>, </span>
<span>                 group_by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"struc_uncert"</span>, <span class="st">"variable"</span><span class="op">)</span>,</span>
<span>                 method <span class="op">=</span> <span class="st">"vincent"</span>, </span>
<span>                 ret_quantiles <span class="op">=</span> <span class="va">q</span>, </span>
<span>                 weighting_scheme <span class="op">=</span> <span class="st">"CDF_exterior"</span>, </span>
<span>                 n_trim <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="va">.</span><span class="op">[</span>, <span class="st">":="</span> <span class="op">(</span>method<span class="op">=</span><span class="st">"Vincent"</span>, </span>
<span>              ntrim <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span><span class="co"># to get aggregate pdfs, sample from std. uniform and draw from distributions</span></span>
<span><span class="va">agg_pdfs_outlier</span> <span class="op">&lt;-</span> <span class="va">agg_cdfs_outlier</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>samps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/approxfun.html" class="external-link">approx</a></span><span class="op">(</span><span class="va">quantile</span>, <span class="va">value</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">100000</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">y</span><span class="op">)</span>, </span>
<span>                     by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">struc_uncert</span>, <span class="va">variable</span>, <span class="va">method</span>, <span class="va">ntrim</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="va">.</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">samps</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="va">.</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/density.html" class="external-link">density</a></span><span class="op">(</span><span class="va">samps</span>, adjust <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span><span class="op">$</span><span class="va">x</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/density.html" class="external-link">density</a></span><span class="op">(</span><span class="va">samps</span>, adjust <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span><span class="op">$</span><span class="va">y</span><span class="op">)</span>, </span>
<span>    by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">struc_uncert</span>, <span class="va">variable</span>, <span class="va">method</span>, <span class="va">ntrim</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<p>We plot the resulting aggregate distributions.</p>
<p><img src="SIRS-vignette_files/figure-html/outlier-plot-aggs-1.png" width="768"></p>
<p>Let’s see how these aggregates perform against the alternate truth
scenarios.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># implement CRPS</span></span>
<span><span class="va">scores_outlier</span> <span class="op">&lt;-</span> <span class="va">obs</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">variable</span>, <span class="va">value</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>obs <span class="op">=</span> <span class="va">value</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>obs_num <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">obs</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">agg_cdfs_outlier</span><span class="op">)</span></span>
<span><span class="co"># get CRPS score</span></span>
<span><span class="va">scores_outlier</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setDT.html" class="external-link">setDT</a></span><span class="op">(</span><span class="va">scores_outlier</span><span class="op">)</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>CRPS <span class="op">=</span> <span class="fu">CRPS</span><span class="op">(</span><span class="va">quantile</span>,<span class="va">value</span>,<span class="va">obs</span><span class="op">)</span><span class="op">)</span>, <span class="co">#</span></span>
<span>                   by<span class="op">=</span><span class="fu">.</span><span class="op">(</span><span class="va">method</span>, <span class="va">ntrim</span>, <span class="va">variable</span>, <span class="va">struc_uncert</span>, <span class="va">obs_num</span>, <span class="va">obs</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<p><img src="SIRS-vignette_files/figure-html/outlier-plot-crps-diff-1.png" width="768"></p>
<p><img src="SIRS-vignette_files/figure-html/outlier-CRPS-dists-cum-1.png" width="768"></p>
<p>Lastly, we plot how often is each aggregate distribution the best
performer.</p>
<p><img src="SIRS-vignette_files/figure-html/outlier-best-CRPS-1.png" width="768"></p>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-bailey_mathematical_1957" class="csl-entry">
Bailey, Norman T. J. 1957. <em>The Mathematical Theory of
Epidemics</em>. London: C. Griffin.
</div>
<div id="ref-EAH-ms" class="csl-entry">
Howerton, Emily, Michael C. Runge, Tiffany L. Bogich, Rebecca K.
Borchering, Hidetoshi Inamine, Justin Lessler, Luke C. Mullany, et al.
n.d. <span>“Context-Dependent Representation of Within- and
Between-Model Uncertainty: Aggregating Probabilistic Predictions in
Infectious Disease Epidemiology.”</span> <em>In Prep</em>.
</div>
<div id="ref-matheson_scoring_1976-1" class="csl-entry">
Matheson, James E., and Robert L. Winkler. 1976. <span>“Scoring
<span>Rules</span> for <span>Continuous Probability
Distributions</span>.”</span> <em>Management Science</em> 22 (10):
1087–96.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Emily Howerton.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
